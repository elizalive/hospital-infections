<html>
<head>
  <!-- Latest compiled and minified Bootstrap CSS -->
  <link rel="stylesheet" href="css/bootstrap.css"> 
  <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
  <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
  <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v2/themes/css/cartodb.ie.css" />
  <![endif]-->
  <style>
    html, body {width:100%; height:100%; padding: 0; margin: 0;}
    #cartodb-map { width: 100%; height:100%; background: white;}
  </style>

  <script>
      var sublayers = [];

      var lon,
        lat,
        total = 10;

      function updateQuery() {
      sublayers[0].set({
        sql: "SELECT * FROM hospitals_no_null_totalhacscore",
      });
    }

      function mapToPosition(position) {
      lon = position.coords.longitude;
      lat = position.coords.latitude;
      updateQuery();
      map.setView(new L.LatLng(lat,lon), 13);
      new L.CircleMarker([lat,lon],{radius: 4}).addTo(map);
      }
      function detectUserLocation(){
        if (navigator.geolocation) {
          var timeoutVal = 10 * 1000 * 1000;
          navigator.geolocation.watchPosition(
            mapToPosition, 
            alertError,
            { enableHighAccuracy: true, timeout: timeoutVal, maximumAge: 0 }
          );
        }
        else {
          alert("Geolocation is not supported by this browser");
        }
      
        function alertError(error) {
          var errors = { 
            1: 'Permission denied',
            2: 'Position unavailable',
            3: 'Request timeout'
          };
          alert("Error: " + errors[error.code]);
        }
      }
      var lon,
          lat,
          total = 10;

      var map;

      function init(){
        // initiate leaflet map
        map = new L.Map('cartodb-map', { 
          center: [35,-90],
          zoom: 5
        })

        L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
          attribution: 'Mapbox <a href="http://mapbox.com/about/maps" target="_blank">Terms &amp; Feedback</a>'
        }).addTo(map);
      
      var layerUrl = 'http://decodedc.cartodb.com/api/v2/viz/0e1a4690-cdbb-11e4-92eb-0e0c41326911/viz.json';
      cartodb.createLayer(map, layerUrl)
      .addTo(map)
      .on('done', function(layer) {
        // change the query for the first layer
        var v = cdb.vis.Overlay.create('search', map.viz, {})
                v.show();
                $('#map').append(v.render().el);
        var subLayerOptions = {
          sql: "SELECT * FROM hospitals_no_null_totalhacscore",
        }
        var sublayer = layer.getSubLayer(0);

        sublayer.set(subLayerOptions);

        sublayers.push(sublayer);
        detectUserLocation();
      }).on('error', function() {
        //log the error
      });
    }
  </script>
</head>
<body onload="init()">
  <h1>Find penalized hospitals near you</h1>
  <div class="introtext">
    <p>Let the browser find your location to see hospitals in your area. Hover over a point to learn more.</p>
    <p> Find hospitals anywhere in the U.S. by typing a city, state or address in the search box.</p>
  </div>
  <div id='cartodb-map'></div>
</body>
</html>